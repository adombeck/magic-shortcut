#!/bin/sh
# Handle Ruby stacktrace in clipboard

clipboard=$(cat)

# Ruby stacktrace pattern: '   path/to/file.rb:123:in ...'
result=$(echo "$clipboard" | sed -n 's/^\s*\([^:]*\):\([0-9]*\):.*$/\1|\2/p' | head -n 1)

path="${result%%|*}"
line_number="${result##*|}"

if [ -z "$path" ] || [ -z "$line_number" ]; then
    # Not a Ruby stacktrace, exit without handling
    exit 0
fi

if [ ! -f "$path" ]; then
    # The extracted path does not exist as a file, exit without handling
    exit 0
fi

body="$path:$line_number"

jq -n \
    --arg path "$path" \
    --arg body "$body" \
    --argjson line "$line_number" \
    '{
        handled: true,
        message: {
            title: "Opening Ruby Stacktrace",
            body: $body
        },
        action: "open_file",
        path: $path,
        line_number: $line
    }'
